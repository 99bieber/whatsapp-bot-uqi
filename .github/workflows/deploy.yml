name: Auto Deploy & Restart Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout Kode
      uses: actions/checkout@v4

    - name: Install Dependencies
      shell: cmd
      run: |
        echo ðŸ“ Masuk ke folder proyek
        cd /d D:\Pengkodingan\whatsapp-bot-uqi
        echo ðŸ“¦ Install dependencies...
        npm install

    - name: Install PM2 dan Jalankan Bot
      shell: cmd
      run: |
        cd /d D:\Pengkodingan\whatsapp-bot-uqi

        echo ðŸ” Mengecek apakah PM2 sudah terinstal...
        where pm2 || npm install -g pm2

        REM Pastikan PATH npm global user Administrator aktif di session ini
        set PATH=%PATH%;C:\Users\Administrator\AppData\Roaming\npm

        echo âœ… Cek versi PM2...
        pm2 -v

        echo ðŸš€ Menjalankan atau me-restart bot...
        pm2 describe bot-absen >nul 2>&1
        if %errorlevel%==0 (
          echo ðŸ”„ Bot ditemukan, me-restart...
          pm2 restart bot-absen
        ) else (
          echo ðŸ†• Bot belum berjalan, menjalankan baru...
          pm2 start index.js --name "bot-absen"
        )

        pm2 save

    - name: Cek Status PM2
      shell: cmd
      run: |
        set PATH=%PATH%;C:\Users\Administrator\AppData\Roaming\npm
        pm2 list
