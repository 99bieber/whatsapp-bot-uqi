name: Auto Deploy & Restart Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    # 1ï¸âƒ£ Ambil kode dari repository
    - name: Checkout Kode
      uses: actions/checkout@v4

    # 2ï¸âƒ£ Masuk ke folder proyek dan install dependencies
    - name: Install Dependencies
      shell: cmd
      run: |
        echo ğŸ“ Masuk ke folder proyek
        cd /d D:\Pengkodingan\whatsapp-bot-uqi

        echo ğŸ“¦ Install dependencies...
        npm install

    # 3ï¸âƒ£ Pastikan PM2 Terinstal (install jika belum ada)
    - name: Pastikan PM2 Terinstal
      shell: cmd
      run: |
        echo ğŸ” Mengecek apakah PM2 sudah terinstal...
        where pm2 || npm install -g pm2

        REM Tambahkan PATH npm global (user Administrator)
        setx PATH "%PATH%;C:\Users\Administrator\AppData\Roaming\npm"

        echo âœ… Cek versi PM2
        pm2 -v

    # 4ï¸âƒ£ Restart atau jalankan bot dengan PM2
    - name: Restart Bot via PM2
      shell: cmd
      run: |
        cd /d D:\Pengkodingan\whatsapp-bot-uqi

        REM Pastikan PM2 ada di PATH
        set PATH=%PATH%;C:\Users\Administrator\AppData\Roaming\npm

        echo ğŸš€ Menjalankan atau me-restart bot...
        pm2 describe bot-absen >nul 2>&1
        if %errorlevel%==0 (
          echo ğŸ”„ Bot ditemukan, me-restart...
          pm2 restart bot-absen
        ) else (
          echo ğŸ†• Bot belum berjalan, menjalankan baru...
          pm2 start index.js --name "bot-absen"
        )

        pm2 save

    # 5ï¸âƒ£ Cek status semua proses PM2
    - name: Cek Status PM2
      shell: cmd
      run: |
        set PATH=%PATH%;C:\Users\Administrator\AppData\Roaming\npm
        pm2 list
