name: Auto Deploy & Restart Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    # 1. Ambil kode dari repository
    - name: Checkout Kode
      uses: actions/checkout@v4

    # 2. Pindah ke folder proyek dan install dependencies
    - name: Install Dependencies
      shell: pwsh
      run: |
        Write-Host "ğŸ“ Masuk ke folder proyek"
        cd D:\Pengkodingan\whatsapp-bot-uqi

        Write-Host "ğŸ“¦ Install dependencies..."
        npm install

    # 3. Pastikan PM2 terinstal (atau install jika belum ada)
    - name: Pastikan PM2 Terinstal
      shell: pwsh
      run: |
        Write-Host "ğŸ” Mengecek apakah PM2 sudah terinstal..."
        if (-not (Get-Command pm2 -ErrorAction SilentlyContinue)) {
          Write-Host "âš™ï¸ PM2 belum terinstal, menginstal global..."
          npm install -g pm2
        } else {
          Write-Host "âœ… PM2 sudah terinstal"
        }

        Write-Host "ğŸ“‚ Menambahkan PM2 ke PATH..."
        $env:PATH += ";C:\Users\runneradmin\AppData\Roaming\npm"
        pm2 -v

    # 4. Restart atau jalankan bot via PM2
    - name: Restart Bot via PM2
      shell: pwsh
      run: |
        Write-Host "ğŸš€ Menjalankan atau me-restart bot..."
        cd D:\Pengkodingan\whatsapp-bot-uqi

        # Pastikan PM2 dikenali di PATH
        $env:PATH += ";C:\Users\runneradmin\AppData\Roaming\npm"

        try {
          pm2 describe bot-absen > $null 2>&1
          if ($LASTEXITCODE -eq 0) {
            Write-Host "ğŸ”„ Bot ditemukan, me-restart..."
            pm2 restart bot-absen
          } else {
            Write-Host "ğŸ†• Bot belum berjalan, menjalankan baru..."
            pm2 start index.js --name "bot-absen"
          }
        } catch {
          Write-Host "âš ï¸ Error mendeteksi bot, menjalankan baru..."
          pm2 start index.js --name "bot-absen"
        }

        pm2 save

    # 5. Verifikasi status PM2
    - name: Cek Status PM2
      shell: pwsh
      run: |
        $env:PATH += ";C:\Users\runneradmin\AppData\Roaming\npm"
        pm2 list
