# deploy.yml
name: Auto Deploy & Restart Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout Kode Bersih
      uses: actions/checkout@v4

    # =========================================================
    # ⚠️ PERBAIKAN PATH KRITIS UNTUK WINDOWS
    # =========================================================
    - name: Set Environment Path untuk Node dan PM2
      # Ini akan menambahkan folder instalasi global npm ke variabel PATH.
      # Biasanya terletak di: C:\Users\<username>\AppData\Roaming\npm\
      # Runner Anda berjalan sebagai NETWORK SERVICE, jadi Path-nya berbeda.
      # Kita pakai path yang lebih universal untuk runner Windows.
      run: |
        $npmGlobalPath = "$env:APPDATA\npm"
        $env:Path = "$npmGlobalPath;$env:Path"
        
        Write-Host "PATH UPDATED TO: $env:Path"
        npm -v
        pm2 -v
    # =========================================================

    - name: Install Dependencies
      run: npm install

    - name: Restart PM2 Service dan Ambil Log
      # Kita menjalankan pm2 yang sudah diinstal secara global (sekarang Path-nya sudah benar)
      run: |
        npm install -g pm2 # Memastikan PM2 ada (jika terhapus)
        
        # Pindah ke folder proyek
        cd D:\Pengkodingan\whatsapp-bot-uqi
        
        # Restart bot WA Anda
        pm2 restart bot-absen
        
        # Ambil log
        $LogOutput = pm2 logs bot-absen --lines 20 --nostream 2>&1
        
        Write-Host "::group::PM2 Logs (20 Lines - bot-absen)"
        Write-Host $LogOutput
        Write-Host "::endgroup::"
        
        pm2 save