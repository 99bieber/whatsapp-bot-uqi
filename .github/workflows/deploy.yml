name: Auto Deploy & Restart Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout Kode
      uses: actions/checkout@v4

    - name: Install Dependencies
      shell: cmd
      run: |
        echo ðŸ“ Masuk ke folder proyek
        cd /d D:\Pengkodingan\whatsapp-bot-uqi
        npm install

    - name: Jalankan PM2 Restart
      shell: cmd
      run: |
        cd /d D:\Pengkodingan\whatsapp-bot-uqi

        rem Path absolut ke PM2
        set PM2_PATH=C:\Users\Administrator\AppData\Roaming\npm\pm2.cmd

        echo âœ… Mengecek versi PM2...
        "%PM2_PATH%" -v

        echo ðŸš€ Menjalankan atau me-restart bot...
        "%PM2_PATH%" describe bot-absen >nul 2>&1
        if %errorlevel%==0 (
          echo ðŸ”„ Bot ditemukan, me-restart...
          "%PM2_PATH%" restart bot-absen
        ) else (
          echo ðŸ†• Bot belum berjalan, menjalankan baru...
          "%PM2_PATH%" start index.js --name "bot-absen"
        )

        echo ðŸ’¾ Menyimpan konfigurasi PM2...
        "%PM2_PATH%" save

    - name: Restart PM2
      shell: cmd
      run: |
        cd /d D:\Pengkodingan\whatsapp-bot-uqi
        "C:\Users\Administrator\AppData\Roaming\npm\pm2.cmd" restart bot-absen || ^
        "C:\Users\Administrator\AppData\Roaming\npm\pm2.cmd" start index.js --name bot-absen

