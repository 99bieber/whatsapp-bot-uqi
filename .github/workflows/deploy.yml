# deploy.yml
name: Auto Deploy & Restart Bot

on:
  push:
    branches:
      - main # Hanya jalankan ketika ada push ke branch 'main'

jobs:
  deploy:
    runs-on: self-hosted
    
    # ⚠️ HAPUS SEMUA DEFINISI 'env: PM2_HOME'
    # env: PM2_HOME: D:\Pengkodingan\actions-runner\.pm2 
        
    steps:
    - name: Checkout Kode Bersih
      uses: actions/checkout@v4

    - name: Set Environment Path (Minimalis)
      shell: powershell 
      run: |
        # Hanya tambahkan Path NPM global ke PATH (agar npm ditemukan)
        $npmGlobalPath = "$env:APPDATA\npm"
        $env:Path = "$npmGlobalPath;$env:Path"
        
        Write-Host "PATH UPDATED."

    - name: Install Dependencies & Restart PM2 Service
      shell: powershell
      run: |
        # 1. Masuk ke folder proyek bot WA Anda
        cd D:\Pengkodingan\whatsapp-bot-uqi
        
        # 2. Instal PM2 LOKAL. 
        npm install pm2
        
        # 3. Definisikan alias PM2
        $PM2 = ".\node_modules\.bin\pm2.cmd"
        
        # 4. HAPUS PM2 DAEMON LAMA DARI LOKASI DEFAULT (Ini penting)
        # Service Windows seringkali meninggalkan daemon PM2 di lokasi non-standar yang mengunci socket.
        # Kita matikan PM2 dulu, lalu hapus.
        pm2 kill
        
        # 5. START bot WA Anda
        # Kita tidak menggunakan & $PM2, kita andalkan PATH NPM yang sudah di-set
        pm2 start index.js --name "bot-absen" --force
        
        # 6. Simpan konfigurasi
        pm2 save