# deploy.yml
name: Auto Deploy & Restart Bot

on:
  push:
    branches:
      - main # Hanya jalankan ketika ada push ke branch 'main'

jobs:
  deploy:
    runs-on: self-hosted
    
    # =========================================================
    # PERBAIKAN PATH DAN IZIN PM2 KRITIS UNTUK WINDOWS NETWORK SERVICE
    # =========================================================
    env:
        # PM2_HOME harus diatur ke lokasi yang 100% bisa diakses oleh Network Service
        # Kita gunakan folder runner itu sendiri.
        PM2_HOME: D:\Pengkodingan\actions-runner\.pm2 
        
    steps:
    - name: Checkout Kode Bersih
      uses: actions/checkout@v4

    - name: Install Dependencies & Restart PM2 Service
      # Kita menjalankan semua perintah sebagai PowerShell
      shell: powershell
      run: |
        # 1. Tambahkan Path NPM global ke PATH (agar Node.js/npm ditemukan)
        $npmGlobalPath = "$env:APPDATA\npm"
        $env:Path = "$npmGlobalPath;$env:Path"
        
        # 2. Masuk ke folder proyek bot WA Anda
        cd D:\Pengkodingan\whatsapp-bot-uqi
        
        # 3. Instal PM2 LOKAL. Ini andalan kita.
        npm install pm2
        
        # 4. Definisikan alias PM2 dari instalasi lokal
        $PM2 = ".\node_modules\.bin\pm2.cmd"
        
        # 5. HAPUS PROSES PM2 LAMA (Menggunakan sintaks IF/ELSE Windows)
        if (& $PM2 delete bot-absen) { "Bot lama dihapus" } else { "Bot tidak ditemukan (normal)" }
        
        # 6. START bot WA Anda
        & $PM2 start index.js --name "bot-absen" --force
        
        # 7. Simpan konfigurasi
        & $PM2 save