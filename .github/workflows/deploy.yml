# deploy.yml
name: Auto Deploy & Restart Bot

on:
  push:
    branches:
      - main # Hanya jalankan ketika ada push ke branch 'main'

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout Kode Bersih
      uses: actions/checkout@v4

    # =========================================================
    # PERBAIKAN PATH DAN IZIN PM2 KRITIS UNTUK WINDOWS NETWORK SERVICE
    # =========================================================
    - name: Set Environment Path dan Home PM2
      # Pastikan Runner tahu di mana PM2 dan Node berada, dan di mana harus menyimpan file PM2.
      run: |
        # Lokasi folder runner yang sebenarnya
        $RunnerFolder = "D:\Pengkodingan\actions-runner"
        
        # 1. Tentukan folder home PM2 berada di dalam folder runner (.pm2)
        # Ini memberikan izin baca/tulis yang diperlukan oleh NETWORK SERVICE
        $env:PM2_HOME = "$RunnerFolder\.pm2" 
        
        # 2. Tambahkan Path NPM global (tempat PM2 diinstal secara global) ke PATH
        $npmGlobalPath = "$env:APPDATA\npm"
        $env:Path = "$npmGlobalPath;$env:Path"
        
        Write-Host "PM2_HOME set to: $env:PM2_HOME"
        Write-Host "PATH UPDATED."

    - name: Install Dependencies & Restart PM2 Service
      # Jalankan ini di terminal PowerShell (di Runner)
      run: |
        # 1. Masuk ke folder proyek bot WA Anda
        cd D:\Pengkodingan\whatsapp-bot-uqi
        
        # 2. Instal PM2 LOKAL (bukan global) di folder proyek ini.
        # Ini akan memastikan pm2.cmd ada di ./node_modules/.bin/pm2.cmd
        npm install pm2
        
        # 3. Definisikan alias PM2 sebagai cara tercepat. 
        # Kita gunakan Node.js untuk menemukan path PM2 yang benar.
        $PM2 = ".\node_modules\.bin\pm2.cmd"

        # 4. HAPUS PROSES PM2 LAMA (Menggunakan sintaks IF/ELSE Windows)
        # Kita harus menggunakan &($PM2) untuk menjalankan file .cmd di PowerShell
        if (& $PM2 delete bot-absen) { "Bot lama dihapus" } else { "Bot tidak ditemukan (normal)" }
        
        # 5. START bot WA Anda
        & $PM2 start index.js --name "bot-absen" --force
        
        # 6. Simpan konfigurasi
        & $PM2 save
      shell: powershell

    - name: Ambil Log Verifikasi
      # Ambil 20 baris log terakhir dan kirim ke output GitHub Actions
      run: |
        # Pindah ke folder proyek bot WA Anda
        cd D:\Pengkodingan\whatsapp-bot-uqi
        
        $LogOutput = pm2 logs bot-absen --lines 20 --nostream 2>&1
        
        Write-Host "::group::PM2 Logs (20 Lines - bot-absen)"
        Write-Host $LogOutput
        Write-Host "::endgroup::"